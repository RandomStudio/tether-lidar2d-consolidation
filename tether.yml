asyncapi: "2.4.0"
info:
  title: Tether Lidar2D Consolidation Agent
  version: "1.0.0"
  description: |
    An Agent that converts raw scan data (angles and distance measurements) and converts these to a "map" of 2D points, rather like a "point cloud" but on a flat 2D plane. It then applies a clustering algorithm to these points to produce a much smaller number of "tracking points" which are made available to other agents.

servers:
  $ref: "https://raw.githubusercontent.com/RandomStudio/tether/asyncapi/tether.yml#/components/servers"

defaultContentType: application/msgpack

channels:
  lidar2d/{agentIdOrGroup}/scans:
    description:
      $ref: "#/components/channels/scans/description"
    parameters:
      $ref: "#/components/channels/scans/parameters"
    publish:
      $ref: "#/components/channels/scans/publish"

  lidar2d/{agentIdOrGroup}/clusters:
    description:
      $ref: "#/components/channels/clusters/description"
    parameters:
      $ref: "#/components/channels/clusters/parameters"
    subscribe:
      $ref: "#/components/channels/clusters/subscribe"

  lidar2d/{agentIdOrGroup}/trackedPoints:
    description:
      $ref: "#/components/channels/trackedPoints/description"
    parameters:
      $ref: "#/components/channels/trackedPoints/parameters"
    subscribe:
      $ref: "#/components/channels/trackedPoints/subscribe"

components:
  channels:
    scans:
      description: A single "scan" frame, i.e. measurements taken after 360 degrees of rotation.
      parameters:
        agentIdOrGroup:
          $ref: "https://raw.githubusercontent.com/RandomStudio/tether/asyncapi/tether.yml#/components/parameters/agentIdOrGroup"
      publish:
        summary: Input Plug for scans
        message:
          $ref: "#/components/messages/scans"
      subscribe:
        summary: Output Plug for scans
        message:
          $ref: "#/components/messages/scans"

    clusters:
      description: A list of "clusters", which are 2D coordinates that are *not* normalised to a particular range. The clusters may be based on a set (scans) from one or more LIDAR scanners.
      parameters:
        agentIdOrGroup:
          $ref: "https://raw.githubusercontent.com/RandomStudio/tether/asyncapi/tether.yml#/components/parameters/agentIdOrGroup"
      subscribe:
        summary: Outplug Plug for clusters
        message:
          $ref: "#/components/messages/clusters"
      publish:
        summary: Input Plug for clusters
        message:
          $ref: "#/components/messages/clusters"

    trackedPoints:
      description: Valid tracking points that are normalised within the range [0,1] for both X and Y axes, within the "region of interest" (ROI) defined in the agent's configuration.
      parameters:
        agentIdOrGroup:
          $ref: "https://raw.githubusercontent.com/RandomStudio/tether/asyncapi/tether.yml#/components/parameters/agentIdOrGroup"
      publish:
        summary: Input Plug for trackedPoints
        message:
          $ref: "#/components/messages/scans"
      subscribe:
        summary: Output Plug for trackedPoints
        message:
          $ref: "#/components/messages/trackedPoints"

  messages:
    scans:
      name: scans
      title: Scan Frames
      summary: Distance measurements from each Scan Frame
      payload:
        $ref: "#/components/schemas/scansPayload"
    clusters:
      name: clusters
      title: List of clusters
      summary: 2D points with non-normalised position, and including a size (radius). Not typically suitable for final tracking data, but may be useful for configuration, troubleshooting and debugging.
      payload:
        $ref: "#/components/schemas/trackedPointsPayload"
    trackedPoints:
      name: trackedPoints
      title: 2D Tracked Points
      summary: Normalised tracked points within the ROI
      payload:
        $ref: "#/components/schemas/trackedPointsPayload"

  schemas:
    scansPayload:
      type: array
      items:
        type: array
        minItems: 2
        maxItems: 3
        items:
          type: number
          required:
            - angle
            - distance
          properties:
            angle:
              type: number
              minimum: 0
              maximum: 360
              description: Angle measured in degrees
            distance:
              type: number
              description: Distance measured in millimetres
            quality:
              type: number
              minimum: 0
              maximum: 1
              description: Quality of measurement sample, from 0 (should ignore) to 1 (as reliable as possible)

    trackedPointsPayload:
      type: array
      items:
        type: object
        required:
          - id
          - x
          - y
        properties:
          id:
            type: number
          x:
            type: number
          y:
            type: number
          size:
            type: number
